<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Using Uploadify with Rails 3 - Technical Partner for Startups | Damian Galarza, Fractional CTO</title><meta name=description content="I recently worked on a couple of Rails projects which both implemented the ability to upload photos to the server. One of these projects required the …"><link rel=stylesheet href=/css/style.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-5Y6WCB7SKQ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-5Y6WCB7SKQ")</script><link rel=icon href=/favicon.ico><link rel=canonical href=https://damiangalarza.com/posts/2010-08-25-using-uploadify-with-rails-3/><meta property="og:type" content="article"><meta property="og:title" content="Using Uploadify with Rails 3"><meta property="og:description" content><meta property="og:url" content="https://damiangalarza.com/posts/2010-08-25-using-uploadify-with-rails-3/"><meta property="og:site_name" content="Technical Partner for Startups | Damian Galarza, Fractional CTO"><meta property="og:image" content="https://damiangalarza.com/images/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta property="og:image:alt" content="Damian Galarza - Technical Partner & Fractional CTO"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@dgalarza"><meta name=twitter:creator content="@dgalarza"><meta name=twitter:image content="https://damiangalarza.com/images/og-image.png"><meta name=twitter:image:alt content="Damian Galarza - Technical Partner & Fractional CTO"><meta property="article:author" content="Damian Galarza"><meta property="article:published_time" content="2010-08-25T02:29:53Z"><meta property="article:modified_time" content="2010-08-25T02:29:53Z"><meta property="article:tag" content="web-development"><meta property="article:tag" content="rails"><meta property="article:tag" content="ruby"><meta property="article:tag" content="javascript"><meta property="article:tag" content="tutorial"><meta name=author content="Damian Galarza"><meta name=article:author content="Damian Galarza"><meta name=article:published_time content="2010-08-25T02:29:53Z"><meta name=article:modified_time content="2010-08-25T02:29:53Z"><meta name=article:tag content="web-development"><meta name=article:tag content="rails"><meta name=article:tag content="ruby"><meta name=article:tag content="javascript"><meta name=article:tag content="tutorial"><meta name=robots content="index, follow"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using Uploadify with Rails 3","description":"\u003cp\u003eI recently worked on a couple of Rails projects which both implemented the ability to upload photos to the server.  One of these projects required the ability to upload multiple files at once and since HTML5 multi-file uploads aren\u0026rsquo;t ready yet I needed another solution. So I decided to move forward using a Flash based uploader, specifically \u003ca href=\u0022http:\/\/www.uploadify.com\/\u0022\u003eUploadify\u003c\/a\u003e. Uploadify is a jQuery plugin which allows you to upload multiple files through a Flash based interface which provides helpful functionality like progress bars and multi-upload queuing, along with this, it\u0026rsquo;s super easy to use.\u003c\/p\u003e","author":{"@type":"Person","name":"Damian Galarza","url":"https:\/\/damiangalarza.com\/"},"publisher":{"@type":"Person","name":"Damian Galarza","url":"https:\/\/damiangalarza.com\/"},"datePublished":"2010-08-25T02:29:53Z","dateModified":"2010-08-25T02:29:53Z","url":"https:\/\/damiangalarza.com\/posts\/2010-08-25-using-uploadify-with-rails-3\/","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/damiangalarza.com\/posts\/2010-08-25-using-uploadify-with-rails-3\/"},"keywords":"[\"web-development\",\"rails\",\"ruby\",\"javascript\",\"tutorial\"]"}</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel=stylesheet></head><body class="min-h-screen flex flex-col"><header class="fixed top-0 left-0 right-0 z-50 bg-[var(--color-dark-bg)]/95 backdrop-blur-sm"><nav class="max-w-7xl mx-auto px-6 lg:px-12 py-5"><div class="flex items-center justify-between"><a href=https://damiangalarza.com/ class="flex items-center gap-3"><img src=/images/logo-icon.svg alt class="h-6 w-6">
<img src=/images/logo.svg alt="Damian Galarza" class="h-4 w-auto">
</a><button id=menu-toggle class="md:hidden text-gray-400 hover:text-white" aria-label="Toggle mobile menu">
<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button><div id=menu class="hidden md:flex items-center gap-8"><a href=https://damiangalarza.com/#contact class="btn-primary text-sm">Contact me</a></div></div><div id=mobile-menu class="hidden md:hidden mt-4 pt-4 border-t border-gray-800"><div class="flex flex-col gap-4"><a href=https://damiangalarza.com/ class="text-gray-300 hover:text-white transition-colors">Home</a>
<a href=/posts/ class="text-gray-300 hover:text-white transition-colors">Blog</a>
<a href=https://damiangalarza.com/#contact class="text-gray-300 hover:text-white transition-colors">Contact me</a></div></div></nav></header><script>const menuToggle=document.getElementById("menu-toggle"),mobileMenu=document.getElementById("mobile-menu");menuToggle.addEventListener("click",()=>{mobileMenu.classList.toggle("hidden")})</script><div class=h-20></div><main class=flex-1><article class="py-20 px-6 lg:px-8"><div class="max-w-4xl mx-auto"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/damiangalarza.com\/"},{"@type":"ListItem","position":2,"name":"Blog","item":"https:\/\/damiangalarza.com\/posts/"},{"@type":"ListItem","position":3,"name":"Using Uploadify with Rails 3","item":"https:\/\/damiangalarza.com\/posts\/2010-08-25-using-uploadify-with-rails-3\/"}]}</script><nav aria-label=Breadcrumb class=mb-12><ol class="flex items-center gap-3 text-sm text-gray-400 min-w-0"><li><a href=https://damiangalarza.com/ class="hover:text-white transition-colors">Home</a></li><li class=text-gray-600><span>/</span></li><li><a href=/posts/ class="hover:text-white transition-colors">Blog</a></li><li class=text-gray-600><span>/</span></li><li class="text-gray-500 truncate" aria-current=page>Using Uploadify with Rails 3</li></ol></nav><header class=mb-12><h1 class="text-4xl md:text-5xl font-bold mb-4">Using Uploadify with Rails 3</h1><div class="flex items-center gap-4 text-gray-400"><time datetime=2010-08-25>August 25, 2010</time>
<span>•</span>
<span>7 min read</span></div><div class="flex gap-2 mt-4 flex-wrap"><a href=/tags/web-development class="text-sm px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded-full text-gray-300 transition-colors">web-development
</a><a href=/tags/rails class="text-sm px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded-full text-gray-300 transition-colors">rails
</a><a href=/tags/ruby class="text-sm px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded-full text-gray-300 transition-colors">ruby
</a><a href=/tags/javascript class="text-sm px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded-full text-gray-300 transition-colors">javascript
</a><a href=/tags/tutorial class="text-sm px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded-full text-gray-300 transition-colors">tutorial</a></div></header><div class="prose prose-invert prose-lg max-w-none"><p>I recently worked on a couple of Rails projects which both implemented the ability to upload photos to the server. One of these projects required the ability to upload multiple files at once and since HTML5 multi-file uploads aren&rsquo;t ready yet I needed another solution. So I decided to move forward using a Flash based uploader, specifically <a href=http://www.uploadify.com/>Uploadify</a>. Uploadify is a jQuery plugin which allows you to upload multiple files through a Flash based interface which provides helpful functionality like progress bars and multi-upload queuing, along with this, it&rsquo;s super easy to use.</p><p>Well that is until you&rsquo;re trying to work with a Rails application. There are lots of resources around that go into the details of how to get this to work but the real issue that I had was that they were mostly for Rails 2.3.8 and my application is now using Rails 3 and the methods described in all of these articles don&rsquo;t completely apply to Rails 3.</p><h3>Why is this extra work needed?</h3><p>Before moving forward on how to get everything working let&rsquo;s take a look at why it&rsquo;s not working in the first place to better understand what we&rsquo;re dealing with and how we&rsquo;re fixing the problem.</p><p>Requests made via POST, PUT, DELETE all require a valid authentication token and session information in order to complete the request successfully in order to protect against Cross-site request forgery. When building out forms using Rails form helpers, a hidden input is created which contains the authenticity token to prove the authenticity of the request along with your session cookie data.</p><p>This poses 2 problems for us using Flash to upload files.</p><p>First, Uploadify is not going to automatically send the authenticity token with the POST request. Second, Flash based requests do not send our session information along with the request. The first situation is pretty easy to fix while the session information requires a little more work on our part.</p><h3>Sending the Authentication_Token</h3><p>Let&rsquo;s start by sending the authenticity token along with the request. In previous versions of Rails we would have had to found a way to get the authenticity token to send but as part of Rails 3 usage of Unobtrusive JavaScript, it now includes a new helper method called <code>csrf_meta_tag</code>. This helper method will provide us with 2 meta tags, <strong>csrf-param</strong> and <strong>csrf-token</strong></p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#cba6f7>meta</span> <span style=color:#89b4fa>name</span><span style=color:#89dceb;font-weight:700>=</span><span style=color:#a6e3a1>&#34;csrf-param&#34;</span> <span style=color:#89b4fa>content</span><span style=color:#89dceb;font-weight:700>=</span><span style=color:#a6e3a1>&#34;authenticity_token&#34;</span>/&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#cba6f7>meta</span> <span style=color:#89b4fa>name</span><span style=color:#89dceb;font-weight:700>=</span><span style=color:#a6e3a1>&#34;csrf-token&#34;</span> <span style=color:#89b4fa>content</span><span style=color:#89dceb;font-weight:700>=</span><span style=color:#a6e3a1>&#34;s2yuw7u24N9fni1m+Wynr595kTphEeMrNSWPAnMroLM=&#34;</span>/&gt;
</span></span></code></pre></div><p>Once we have the CSRF meta tags in place, we can move forward and add the authenticity to the parameters which are sent with Uploadify&rsquo;s request. The JavaScript snippet below is an example of pulling the CSRF token information and passing it along with our Uploadify requests using the scriptData configuration parameter.</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#89dceb;font-weight:700>&lt;</span>script type<span style=color:#89dceb;font-weight:700>=</span><span style=color:#a6e3a1>&#34;text/javascript&#34;</span><span style=color:#89dceb;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>$(<span style=color:#f38ba8>function</span> () {
</span></span><span style=display:flex><span>  <span style=color:#6c7086;font-style:italic>// Create an empty object to store our custom script data
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>  <span style=color:#f38ba8>var</span> uploadify_script_data <span style=color:#89dceb;font-weight:700>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6c7086;font-style:italic>// Fetch the CSRF meta tag data
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>  <span style=color:#f38ba8>var</span> csrf_token <span style=color:#89dceb;font-weight:700>=</span> $(<span style=color:#a6e3a1>&#39;meta[name=csrf-token]&#39;</span>).attr(<span style=color:#a6e3a1>&#39;content&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#f38ba8>var</span> csrf_param <span style=color:#89dceb;font-weight:700>=</span> $(<span style=color:#a6e3a1>&#39;meta[name=csrf-param]&#39;</span>).attr(<span style=color:#a6e3a1>&#39;content&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6c7086;font-style:italic>// Now associate the data in the config, encoding the data safely
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>  uploadify_script_data[csrf_token] <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#89dceb>encodeURI</span>(csrf_param);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#6c7086;font-style:italic>// Configure Uploadify
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>  $(<span style=color:#a6e3a1>&#39;#photo-upload&#39;</span>).uploadify({
</span></span><span style=display:flex><span>    <span style=color:#a6e3a1>&#39;uploader&#39;</span> <span style=color:#89dceb;font-weight:700>:</span> <span style=color:#a6e3a1>&#39;/assets/uploadify.swf&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e3a1>&#39;script&#39;</span> <span style=color:#89dceb;font-weight:700>:</span> <span style=color:#a6e3a1>&#39;/photos/&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e3a1>&#39;scriptData&#39;</span> <span style=color:#89dceb;font-weight:700>:</span> uploadify_script_data
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#89dceb;font-weight:700>&lt;</span><span style=color:#f38ba8>/script&gt;</span>
</span></span></code></pre></div><p>Uploadify allows you to pass extra data along with it&rsquo;s request using the scriptData parameter which accepts an object of properties to send with the request. In our case we are fetching the CSRF and creating a new property in the scriptData object with the name of the CSRF token and setting it&rsquo;s value to the CSRF param. Using this, we can pass along the authenticity token with the request. It&rsquo;s important to note that we are encoding the authentication token value using encodeURI to escape any special characters so the data gets sent along to the server correctly.</p><p>I actually ran into an issue where even using encodeURI once was not enough and I needed to double encode because + signs were being converted into spaces.
So if you are continuing to run into InvalidAuthenticityToken error, check your log to see that the authenticity token is being correctly sent along. While trying to debug the problem a quick look into the log showed that I was receiving</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ruby data-lang=ruby><span style=display:flex><span>authenticity_token<span style=color:#89dceb;font-weight:700>=&gt;</span><span style=color:#a6e3a1>&#34;3WB Cj0h7y4St5ZyvlYU xIEVT7yIIr6IRAhOOLCb5w=
</span></span></span></code></pre></div><p>The spaces in the above authenticity token should have been + signs instead. In order to resolve this issue I ended up having to double encode the authenticity token before sending it along like so:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span>uploadify_script_data[csrf_token] <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#89dceb>encodeURI</span>(<span style=color:#89dceb>encodeURI</span>(csrf_param));
</span></span></code></pre></div><p>Now that we have the authenticity token being sent by Uploadify, let&rsquo;s move forward and get our session information passed along as well.</p><h3>Passing the Session Cookie</h3><p>One of the first steps to passing the session cookie along with our Uploadify requests is to add it to the scriptData like we did with the authentication_token. Unfortunately there is no quick way to handle this through JavaScript alone, we need to include it using some ERB to apply it.</p><p>In earlier versions of Rails the session cookie key could be accessed via: <code>ActionController::Base.session_options[:key]</code></p><p>As of Rails 3 though we can access the session cookie key using: <code>Rails.application.config.session_options[:key]</code></p><p>Below is a simple example of how to send the session cookie information in the scriptData.</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#89dceb;font-weight:700>&lt;</span>script type<span style=color:#89dceb;font-weight:700>=</span><span style=color:#a6e3a1>&#34;text/javascript&#34;</span><span style=color:#89dceb;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#89dceb;font-weight:700>&lt;%-</span> session_key <span style=color:#89dceb;font-weight:700>=</span> Rails.application.config.session_options[<span style=color:#89dceb;font-weight:700>:</span>key] <span style=color:#89dceb;font-weight:700>-%&gt;</span>
</span></span><span style=display:flex><span>$(<span style=color:#f38ba8>function</span> () {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f38ba8>var</span> uploadify_script_data <span style=color:#89dceb;font-weight:700>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6c7086;font-style:italic>// Fetch the CSRF meta tag data
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>  <span style=color:#f38ba8>var</span> csrf_token <span style=color:#89dceb;font-weight:700>=</span> $(<span style=color:#a6e3a1>&#39;meta[name=csrf-token]&#39;</span>).attr(<span style=color:#a6e3a1>&#39;content&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#f38ba8>var</span> csrf_param <span style=color:#89dceb;font-weight:700>=</span> $(<span style=color:#a6e3a1>&#39;meta[name=csrf-param]&#39;</span>).attr(<span style=color:#a6e3a1>&#39;content&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6c7086;font-style:italic>// Now associate the data in the config, encoding the data safely
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>  uploadify_script_data[csrf_token] <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#89dceb>encodeURI</span>(csrf_param)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6c7086;font-style:italic>// Associate the session information
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>  uploadify_script_data[<span style=color:#a6e3a1>&#39;&lt;%= session_key %&gt;&#39;</span>] <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#a6e3a1>&#39;&lt;%= cookies[session_key] %&gt;&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  $(<span style=color:#a6e3a1>&#39;#upload-photo&#39;</span>).uploadify({
</span></span><span style=display:flex><span>    script <span style=color:#89dceb;font-weight:700>:</span> <span style=color:#a6e3a1>&#39;/photos/&#39;</span>,
</span></span><span style=display:flex><span>    scriptData <span style=color:#89dceb;font-weight:700>:</span> uploadify_script_data
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#89dceb;font-weight:700>&lt;</span><span style=color:#f38ba8>/script&gt;</span>
</span></span></code></pre></div><p>Now that we have the session cookie data being passed with the request we&rsquo;ll need to move forward and have that information set with the headers of the Flash request, enter Middleware.</p><h3>Rack Middleware</h3><p>In order to get the session information to be associated with the request correctly we&rsquo;ll need to create some custom middleware which will intercept the requests from Flash and inject the cookie information into the header.</p><p>Some middleware has been around for accomplishing this but most are not compatible with Rails 3. I&rsquo;ve posted a Gist on Github which has a working middleware for Rails 3 which I found on <a href=http://metautonomo.us/2010/07/09/uploadify-and-rails-3/>metautonomo.us</a> which we can use to accomplish our task.</p><p>Create a file in app/middleware/flash_session_cookie_middleware.rb creating the middleware directory if it doesn&rsquo;t already exist and add the following code in it:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#89dceb>require</span> <span style=color:#a6e3a1>&#39;rack/utils&#39;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#cba6f7>class</span> <span style=color:#f9e2af>FlashSessionCookieMiddleware</span>
</span></span><span style=display:flex><span>  <span style=color:#cba6f7>def</span> <span style=color:#89b4fa>initialize</span>(app, session_key <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#a6e3a1>&#39;_session_id&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#f5e0dc>@app</span> <span style=color:#89dceb;font-weight:700>=</span> app
</span></span><span style=display:flex><span>    <span style=color:#f5e0dc>@session_key</span> <span style=color:#89dceb;font-weight:700>=</span> session_key
</span></span><span style=display:flex><span>  <span style=color:#cba6f7>end</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#cba6f7>def</span> <span style=color:#89b4fa>call</span>(env)
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>if</span> env<span style=color:#89dceb;font-weight:700>[</span><span style=color:#a6e3a1>&#39;HTTP_USER_AGENT&#39;</span><span style=color:#89dceb;font-weight:700>]</span> <span style=color:#89dceb;font-weight:700>=~</span> <span style=color:#94e2d5>/^(Adobe|Shockwave) Flash/</span>
</span></span><span style=display:flex><span>      req <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#f9e2af>Rack</span><span style=color:#89dceb;font-weight:700>::</span><span style=color:#f9e2af>Request</span><span style=color:#89dceb;font-weight:700>.</span>new(env)
</span></span><span style=display:flex><span>      env<span style=color:#89dceb;font-weight:700>[</span><span style=color:#a6e3a1>&#39;HTTP_COOKIE&#39;</span><span style=color:#89dceb;font-weight:700>]</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#89dceb;font-weight:700>[</span> <span style=color:#f5e0dc>@session_key</span>,
</span></span><span style=display:flex><span>                             req<span style=color:#89dceb;font-weight:700>.</span>params<span style=color:#89dceb;font-weight:700>[</span><span style=color:#f5e0dc>@session_key</span><span style=color:#89dceb;font-weight:700>]</span> <span style=color:#89dceb;font-weight:700>].</span>join(<span style=color:#a6e3a1>&#39;=&#39;</span>)<span style=color:#89dceb;font-weight:700>.</span>freeze <span style=color:#cba6f7>unless</span> req<span style=color:#89dceb;font-weight:700>.</span>params<span style=color:#89dceb;font-weight:700>[</span><span style=color:#f5e0dc>@session_key</span><span style=color:#89dceb;font-weight:700>].</span>nil?
</span></span><span style=display:flex><span>      env<span style=color:#89dceb;font-weight:700>[</span><span style=color:#a6e3a1>&#39;HTTP_ACCEPT&#39;</span><span style=color:#89dceb;font-weight:700>]</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#a6e3a1>&#34;</span><span style=color:#a6e3a1>#{</span>req<span style=color:#89dceb;font-weight:700>.</span>params<span style=color:#89dceb;font-weight:700>[</span><span style=color:#a6e3a1>&#39;_http_accept&#39;</span><span style=color:#89dceb;font-weight:700>]</span><span style=color:#a6e3a1>}</span><span style=color:#a6e3a1>&#34;</span><span style=color:#89dceb;font-weight:700>.</span>freeze <span style=color:#cba6f7>unless</span> req<span style=color:#89dceb;font-weight:700>.</span>params<span style=color:#89dceb;font-weight:700>[</span><span style=color:#a6e3a1>&#39;_http_accept&#39;</span><span style=color:#89dceb;font-weight:700>].</span>nil?
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>end</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#f5e0dc>@app</span><span style=color:#89dceb;font-weight:700>.</span>call(env)
</span></span><span style=display:flex><span>  <span style=color:#cba6f7>end</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>end</span>
</span></span></code></pre></div><p>Once you&rsquo;ve created that file we&rsquo;ll need to add the middleware directory to our autoload&rsquo;s path if it isn&rsquo;t already. You can do this by modifying you&rsquo;re config/application.rb file and add the following in the autoload section:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Custom directories with classes and modules you want to be autoloadable.</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># config.autoload_paths += %W(#{config.root}/</span>
</span></span><span style=display:flex><span>config<span style=color:#89dceb;font-weight:700>.</span>autoload_paths <span style=color:#89dceb;font-weight:700>+=</span> <span style=color:#a6e3a1>%W(</span><span style=color:#a6e3a1>#{</span>config<span style=color:#89dceb;font-weight:700>.</span>root<span style=color:#a6e3a1>}</span><span style=color:#a6e3a1>/app/middleware/)</span>
</span></span></code></pre></div><p>Once that&rsquo;s done we have one more step to do, inserting the middleware so that it will go to work when we need it.</p><p>Place the following code in config/initializers/session_store.rb</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#f9e2af>Rails</span><span style=color:#89dceb;font-weight:700>.</span>application<span style=color:#89dceb;font-weight:700>.</span>config<span style=color:#89dceb;font-weight:700>.</span>middleware<span style=color:#89dceb;font-weight:700>.</span>insert_before(
</span></span><span style=display:flex><span>  <span style=color:#f9e2af>ActionDispatch</span><span style=color:#89dceb;font-weight:700>::</span><span style=color:#f9e2af>Session</span><span style=color:#89dceb;font-weight:700>::</span><span style=color:#f9e2af>CookieStore</span>,
</span></span><span style=display:flex><span>  <span style=color:#f9e2af>FlashSessionCookieMiddleware</span>,
</span></span><span style=display:flex><span>  <span style=color:#f9e2af>Rails</span><span style=color:#89dceb;font-weight:700>.</span>application<span style=color:#89dceb;font-weight:700>.</span>config<span style=color:#89dceb;font-weight:700>.</span>session_options<span style=color:#89dceb;font-weight:700>[</span><span style=color:#a6e3a1>:key</span><span style=color:#89dceb;font-weight:700>]</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h4 id=update>Update</h4><p>If you are using ActiveRecord based session storage instead of cookie based session storage you will need the following intializer instead:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#f9e2af>SampleApp</span><span style=color:#89dceb;font-weight:700>::</span><span style=color:#f9e2af>Application</span><span style=color:#89dceb;font-weight:700>.</span>config<span style=color:#89dceb;font-weight:700>.</span>session_store <span style=color:#a6e3a1>:active_record_store</span>, <span style=color:#a6e3a1>:key</span> <span style=color:#89dceb;font-weight:700>=&gt;</span> <span style=color:#a6e3a1>&#39;_uploader_session&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f9e2af>Rails</span><span style=color:#89dceb;font-weight:700>.</span>application<span style=color:#89dceb;font-weight:700>.</span>config<span style=color:#89dceb;font-weight:700>.</span>middleware<span style=color:#89dceb;font-weight:700>.</span>insert_before(
</span></span><span style=display:flex><span>  <span style=color:#f9e2af>Rails</span><span style=color:#89dceb;font-weight:700>.</span>application<span style=color:#89dceb;font-weight:700>.</span>config<span style=color:#89dceb;font-weight:700>.</span>session_store,
</span></span><span style=display:flex><span>  <span style=color:#f9e2af>FlashSessionCookieMiddleware</span>,
</span></span><span style=display:flex><span>  <span style=color:#f9e2af>Rails</span><span style=color:#89dceb;font-weight:700>.</span>application<span style=color:#89dceb;font-weight:700>.</span>config<span style=color:#89dceb;font-weight:700>.</span>session_options<span style=color:#89dceb;font-weight:700>[</span><span style=color:#a6e3a1>:key</span><span style=color:#89dceb;font-weight:700>]</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>Thanks to reader <a href=http:/www.twitter.com/fromthought2web target=_blank>@fromthought2web</a> for sharing his findings!</p><p>With all this in place you should now be ready to successfully upload files via Flash with your Rails project.</p><p>Good luck!</p><h3 id=updates>Updates</h3><dl><dt>2012-04-03</dt><dd>Included sample middleware when using ActiveRecord for session store, thanks to <a href=http://www.twitter.com/fromthought2web target=_blank>@fromthought2web</a> for sharing his finds.</dd><pre><code>&lt;dt&gt;2010-08-26&lt;/dt&gt;
&lt;dd&gt;Resolved issue in code sample where session_key_name was being reference instead of session_key. Original sample updated&lt;/dd&gt;
&lt;dd&gt;`uploadify_script_data['&lt;%= session_key %&gt;'] = '&lt;%= cookies[session_key] %&gt;';`&lt;/dd&gt;
</code></pre></dl></div><footer class="mt-16 pt-8 border-t border-gray-800"><div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4"><a href=https://damiangalarza.com/posts/2009-09-14-css3-webkit-gradient-generator/ class=group><span class="text-sm text-gray-500 group-hover:text-gray-400">← Previous</span><h3 class="font-semibold group-hover:text-[var(--color-accent-teal)] transition-colors">CSS3 Webkit Gradient Generator</h3></a><a href=https://damiangalarza.com/posts/2010-10-27-using-uploadify-with-rails-3-part-2-controller-example/ class="group text-right"><span class="text-sm text-gray-500 group-hover:text-gray-400">Next →</span><h3 class="font-semibold group-hover:text-[var(--color-accent-teal)] transition-colors">Using Uploadify with Rails 3 - Part 2 - Controller Example</h3></a></div></footer></div></article></main><footer class="border-t border-gray-800 py-8 px-6 lg:px-8 section-alt flex items-center min-h-[120px]"><div class="max-w-6xl mx-auto w-full"><div class="flex flex-col md:flex-row justify-between items-center gap-4"><div class="text-center md:text-left"><div class="w-16 h-0.5 bg-[var(--color-accent-teal)] mb-3 mx-auto md:mx-0"></div><p class="text-sm text-gray-500">Ready to build something great together?</p><p class="text-xs text-gray-500 mt-2">© 2025 Damian Galarza. All rights reserved.</p></div><div class="flex items-center gap-6"><a href=https://www.linkedin.com/in/dgalarza/ target=_blank rel=noopener class="text-gray-400 hover:text-accent-teal transition-colors" aria-label="LinkedIn profile"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M19 0H5C2.239.0.0 2.239.0 5v14c0 2.761 2.239 5 5 5h14c2.762.0 5-2.239 5-5V5c0-2.761-2.238-5-5-5zM8 19H5V8h3v11zM6.5 6.732c-.966.0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zM20 19h-3v-5.604c0-3.368-4-3.113-4 0V19h-3V8h3v1.765c1.396-2.586 7-2.777 7 2.476V19z"/></svg>
</a><a href=https://github.com/dgalarza target=_blank rel=noopener class="text-gray-400 hover:text-accent-teal transition-colors" aria-label="GitHub profile"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg>
</a><a href=https://twitter.com/dgalarza target=_blank rel=noopener class="text-gray-400 hover:text-accent-teal transition-colors" aria-label="Twitter profile"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></div></div></div></footer></body></html>